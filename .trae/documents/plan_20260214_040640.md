## 集成方案概述

将 `/home/kyy/workspace/dji_way_line` 项目作为 `wayline` 的独立子项集成，**MapViewer.vue 功能集成到 CesiumMap.vue**，ControlPanel 采用抽屉方式挂载。

---

## MapViewer.vue 功能分析

| 功能 | 实现方式 | 集成方案 |
|------|----------|----------|
| 地图显示 | vue-cesium (vc-viewer) | 复用 CesiumMap 现有地图 |
| 航点显示 | vc-entity + point | 扩展 CesiumMap 添加航点实体 |
| 多边形区域 | vc-graphics-polygon | 扩展 CesiumMap 添加多边形 |
| 连接线 | vc-graphics-polyline | 扩展 CesiumMap 添加航线 |
| 扫描路径 | vc-graphics-polyline | 扩展 CesiumMap 添加扫描路径 |
| 地图点击 | @left-click 事件 | 扩展 useCesiumMouseTool |
| 坐标系统提示 | HTML 元素 | 在 CesiumMap 模板中添加 |

---

## 第一阶段：安装依赖 (已完成 ✓)

```bash
pnpm add jszip fast-xml-parser
```

---

## 第二阶段：工具函数迁移 (1天)

### 2.1 创建目录和文件

```
front/src/utils/waypoint/
├── geoUtils.ts              # 地理计算
├── kmzGenerator.ts          # KMZ 生成
├── kmzParser.ts             # KMZ 解析
├── polygonRouteGenerator.ts # 面状航线生成
├── routePlanner.ts          # 航线规划
└── coordTransform.ts        # 坐标转换
```

### 2.2 迁移内容

从 `dji_way_line/src/utils/` 迁移并转为 TypeScript：
- geoUtils.js → geoUtils.ts
- kmzGenerator.js → kmzGenerator.ts
- kmzParser.js → kmzParser.ts
- polygonRouteGenerator.js → polygonRouteGenerator.ts
- routePlanner.js → routePlanner.ts
- coordTransform.js → coordTransform.ts

---

## 第三阶段：类型定义 (0.5天)

### 3.1 创建类型文件

```
front/src/types/waypoint.ts
```

定义接口：
- `Waypoint` - 航点
- `MissionConfig` - 任务配置
- `RouteStats` - 航线统计
- `PolygonRouteConfig` - 面状航线配置
- `ScanSetting` - 扫描设置

---

## 第四阶段：状态管理 (0.5天)

### 4.1 创建 Vuex 模块

```
front/src/store/modules/waypoint.ts
```

管理状态：
- `waypoints` - 航点列表
- `missionConfig` - 任务配置
- `scanPath` - 扫描路径
- `missions` - 航线库
- `isWaypointMode` - 是否为航点编辑模式

---

## 第五阶段：CesiumMap.vue 扩展 (2天)

### 5.1 扩展原则

**不修改现有功能**，仅添加航点模式支持：

1. 添加 `isWaypointMode` 状态判断
2. 航点模式下启用航点相关功能
3. 非航点模式下保持原有行为

### 5.2 模板扩展

在 `<template>` 中添加：

```vue
<!-- 航点模式工具栏 -->
<div v-if="isWaypointMode" class="waypoint-toolbar">
  <a-button @click="openControlPanel">航线配置</a-button>
</div>

<!-- 航点实体 -->
<template v-if="isWaypointMode">
  <!-- 航点标记 -->
  <cesium-entity v-for="(wp, index) in waypoints" ... />
  <!-- 航线 -->
  <cesium-polyline v-if="waypoints.length > 1" ... />
  <!-- 多边形区域 -->
  <cesium-polygon v-if="isPatrolMode && waypoints.length > 2" ... />
  <!-- 扫描路径 -->
  <cesium-polyline v-if="scanPath.length > 1" ... />
</template>

<!-- 坐标系统提示 -->
<div v-if="isWaypointMode" class="coord-info">
  <span>WGS84</span>
</div>

<!-- 抽屉：ControlPanel -->
<a-drawer v-model:visible="drawerVisible" ...>
  <ControlPanel ... />
</a-drawer>
```

### 5.3 脚本扩展

在 `<script>` 中添加：

```typescript
// 新增状态
const isWaypointMode = computed(() => store.state.waypoint?.isWaypointMode)
const waypoints = computed(() => store.state.waypoint?.waypoints || [])
const scanPath = computed(() => store.state.waypoint?.scanPath || [])
const missionConfig = computed(() => store.state.waypoint?.missionConfig || {})
const drawerVisible = ref(false)

// 新增方法
function openControlPanel() { drawerVisible.value = true }
function handleWaypointClick(coords: {lat: number, lng: number}) { ... }
function renderWaypoints() { ... }
function renderFlightLine() { ... }
function renderScanPath() { ... }
```

### 5.4 扩展 useCesiumMouseTool

添加航点模式支持：

```typescript
// 在 mouseTool 函数中添加
if (mode === 'waypoint') {
  // 航点点击添加逻辑
}
```

---

## 第六阶段：组件迁移 (1.5天)

### 6.1 创建目录结构

```
front/src/components/waypoint/
├── WaypointEditor.vue       # 主编辑器（协调组件）
├── ControlPanel.vue         # 控制面板（抽屉内容）
├── MissionConfig.vue        # 任务配置
├── MissionLibrary.vue       # 航线库
├── WaypointList.vue         # 航点列表
├── PolygonRouteConfig.vue   # 面状航线配置
└── CreateMissionModal.vue   # 创建弹窗
```

### 6.2 WaypointEditor.vue 结构

```vue
<template>
  <div class="waypoint-editor">
    <!-- 复用 CesiumMap，传入航点模式参数 -->
    <CesiumMap 
      :waypoint-mode="true"
      @waypoint-click="onWaypointClick"
    />
    
    <!-- 抽屉：ControlPanel -->
    <a-drawer
      v-model:visible="drawerVisible"
      title="航线编辑"
      placement="right"
      :width="420"
    >
      <ControlPanel
        :missionConfig="missionConfig"
        :waypoints="waypoints"
        :missionStats="missionStats"
        :routeStats="routeStats"
        @update:missionConfig="..."
        @generate="handleGenerateKMZ"
        @import-kmz="handleImportKMZ"
        @save="saveCurrentMission"
      />
    </a-drawer>
    
    <!-- 工具栏按钮 -->
    <div class="toolbar">
      <a-button type="primary" @click="drawerVisible = true">
        航线配置
      </a-button>
    </div>
  </div>
</template>
```

---

## 第七阶段：路由配置 (0.5天)

### 7.1 修改 router/index.ts

```typescript
{
  path: '/' + ERouterName.WAYLINE,
  name: ERouterName.WAYLINE,
  component: () => import('/@/pages/page-web/projects/wayline.vue'),
  children: [
    {
      path: 'editor',
      name: 'WaypointEditor',
      component: () => import('/@/components/waypoint/WaypointEditor.vue')
    }
  ]
}
```

### 7.2 修改 wayline.vue

添加"新建航线"按钮，跳转到编辑器：

```vue
<a-button type="primary" @click="$router.push('/wayline/editor')">
  新建航线
</a-button>
```

---

## 文件变更总览

### 新增文件 (14个)

```
front/src/
├── components/waypoint/
│   ├── WaypointEditor.vue
│   ├── ControlPanel.vue
│   ├── MissionConfig.vue
│   ├── MissionLibrary.vue
│   ├── WaypointList.vue
│   ├── PolygonRouteConfig.vue
│   └── CreateMissionModal.vue
├── utils/waypoint/
│   ├── geoUtils.ts
│   ├── kmzGenerator.ts
│   ├── kmzParser.ts
│   ├── polygonRouteGenerator.ts
│   ├── routePlanner.ts
│   └── coordTransform.ts
├── types/waypoint.ts
└── store/modules/waypoint.ts
```

### 修改文件 (3个)

```
front/package.json              # 已添加依赖 ✓
front/src/router/index.ts       # 添加路由
front/src/pages/page-web/projects/wayline.vue  # 添加入口
```

### 扩展文件 (2个)

```
front/src/components/CesiumMap.vue       # 添加航点模式支持
front/src/hooks/use-cesium-mouse-tool.ts # 添加航点模式
```

---

## 工作量估算

| 阶段 | 工作量 | 状态 |
|------|--------|------|
| 安装依赖 | 0.5天 | ✓ 已完成 |
| 工具函数迁移 | 1天 | 待执行 |
| 类型定义 | 0.5天 | 待执行 |
| 状态管理 | 0.5天 | 待执行 |
| CesiumMap 扩展 | 2天 | 待执行 |
| 组件迁移 | 1.5天 | 待执行 |
| 路由配置 | 0.5天 | 待执行 |
| 测试验证 | 1天 | 待执行 |
| **总计** | **7.5天** | - |
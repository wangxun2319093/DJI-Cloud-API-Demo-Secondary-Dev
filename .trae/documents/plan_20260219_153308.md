# 航线距离计算问题分析与修复计划

## 问题分析

### 当前代码问题
在 `use-wayline.ts` 的 `missionStats` 计算属性中，距离计算只考虑了**水平距离**（经纬度），没有考虑**高度差**：

```javascript
// 当前代码 - 只计算水平距离
const R = 6378137
const dLat = (p2.lat - p1.lat) * Math.PI / 180
const dLng = (p2.lng - p1.lng) * Math.PI / 180
// ... Haversine 公式计算水平距离
distance += R * c  // 缺少高度计算
```

### 问题影响
- 修改航点高度后，航线距离显示不变
- 实际飞行距离被低估（忽略了爬升/下降距离）
- 飞行时间估算不准确

---

## 修复方案

### 计算三维距离
使用勾股定理计算真实的三维距离：

```
三维距离 = √(水平距离² + 高度差²)
```

### 修改代码

**文件**: `front/src/components/wayline/use-wayline.ts`

**修改位置**: `missionStats` 计算属性中的距离计算逻辑

```javascript
// 修复后的代码
const R = 6378137
const dLat = (p2.lat - p1.lat) * Math.PI / 180
const dLng = (p2.lng - p1.lng) * Math.PI / 180
const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
  Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
  Math.sin(dLng / 2) * Math.sin(dLng / 2)
const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
const horizontalDistance = R * c  // 水平距离

// 计算高度差
const height1 = p1.height || missionConfig.value.globalHeight || 50
const height2 = p2.height || missionConfig.value.globalHeight || 50
const heightDiff = Math.abs(height2 - height1)

// 三维距离 = √(水平距离² + 高度差²)
const distance3D = Math.sqrt(horizontalDistance * horizontalDistance + heightDiff * heightDiff)
distance += distance3D
```

---

## 需要修改的文件

| 文件 | 修改内容 |
|------|----------|
| `front/src/components/wayline/use-wayline.ts` | 修改 `missionStats` 中的距离计算逻辑 |

## 预计修改行数: 约 10 行
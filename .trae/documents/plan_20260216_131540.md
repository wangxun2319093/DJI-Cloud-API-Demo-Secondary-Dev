# 无人机模拟器测试计划

## 一、问题分析

### 1. 当前系统状态
- **数据库设备**：
  - DOCKSIM001 (Dock, domain=3, child_sn=1581F6GKB247D004069F)
  - 1581F6GKB247D004069F (Drone, domain=0)
- **Redis状态**：设备在线key已存在
- **前端问题**：设备拓扑API只查询 `REMOTER_CONTROL` (domain=2)，不包含 `DOCK` (domain=3)

### 2. 数据流分析
```
模拟器 → EMQX (10.39.29.101:1883) → 后端订阅 → Redis → 前端API → 页面显示
```

## 二、测试步骤

### 阶段1：环境检查
1. 检查 EMQX 服务状态 (10.39.29.101:1883)
2. 检查后端服务日志，确认 MQTT 连接状态
3. 检查后端订阅的 topic 列表

### 阶段2：模拟器配置
1. 配置模拟器连接到 `10.39.29.101:1883`
2. 配置设备 SN：
   - Dock SN: `DOCKSIM001`
   - Drone SN: `1581F6GKB247D004069F`

### 阶段3：消息发送测试
模拟器需要发送以下 MQTT 消息：

**消息1：设备上线 (sys/product/{sn}/status)**
```json
Topic: sys/product/DOCKSIM001/status
Payload: {
  "tid": "uuid",
  "bid": "uuid",
  "timestamp": 时间戳,
  "data": {
    "domain": 3,
    "type": 1,
    "sub_type": 0,
    "thing_version": "1.0.0",
    "sub_devices": [{
      "sn": "1581F6GKB247D004069F",
      "domain": 0,
      "type": 89,
      "sub_type": 0,
      "index": "A",
      "thing_version": "1.0.0",
      "control_source": "A"
    }]
  }
}
```

**消息2：Dock OSD (thing/product/{sn}/osd)**
```json
Topic: thing/product/DOCKSIM001/osd
Payload: {
  "tid": "uuid",
  "bid": "uuid",
  "timestamp": 时间戳,
  "gateway": "DOCKSIM001",
  "data": {
    "mode_code": 1,
    "cover_state": 0,
    "supplement_light_state": 0,
    "network_state": {...},
    "drone_in_dock": 1,
    "drone_charge_state": {...}
  }
}
```

**消息3：Drone OSD (thing/product/{sn}/osd)**
```json
Topic: thing/product/1581F6GKB247D004069F/osd
Payload: {
  "tid": "uuid",
  "bid": "uuid", 
  "timestamp": 时间戳,
  "gateway": "DOCKSIM001",
  "data": {
    "mode_code": 1,
    "gear": 1,
    "latitude": 纬度,
    "longitude": 经度,
    "height": 高度,
    "elevation": 海拔,
    "battery": {...}
  }
}
```

### 阶段4：验证监控
1. **后端日志监控**：检查是否收到 MQTT 消息
2. **Redis 监控**：检查设备在线状态和 OSD 数据
3. **前端页面**：检查 `http://10.39.29.101:8080/tsa` 设备显示

### 阶段5：问题修复
如果前端仍不显示，需要检查：
1. TopologyServiceImpl 是否需要支持 DOCK 域查询
2. 前端 tsa.vue 的设备显示逻辑

## 三、执行命令

```bash
# 1. 检查 EMQX 连接
mosquitto_pub -h 10.39.29.101 -p 1883 -t "test" -m "hello"

# 2. 启动后端服务（如未运行）
cd /home/kyy/workspace/DJI-Cloud-API-Demo/sample && mvn spring-boot:run

# 3. 启动前端服务（如未运行）
cd /home/kyy/workspace/DJI-Cloud-API-Demo/front && npm run serve

# 4. 运行模拟器发送测试消息
# (需要根据模拟器项目结构编写测试脚本)
```

## 四、预期结果
- 后端日志显示收到 MQTT 消息
- Redis 中设备在线状态和 OSD 数据正确
- 前端页面显示设备在线状态
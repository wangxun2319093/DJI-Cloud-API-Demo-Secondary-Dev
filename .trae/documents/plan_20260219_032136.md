# 修复 DSM 上传功能问题

## 问题诊断

### 问题 1: 前端 API 路径错误
- **现状**: `map.ts` 使用 `/wayline/api/v1`
- **应该**: 使用 `/map/api/v1`（与后端 `url.map.prefix` 配置一致）

### 问题 2: 上传逻辑未真正调用 API
- **现状**: `CreateMapModal.vue` 的 `handleConfirm` 只是模拟进度条
- **应该**: 直接调用 `uploadDsmFile` API

### 问题 3: 数据库表未创建
- **现状**: SQL 文件已修改，但表可能未在数据库中执行
- **应该**: 执行 SQL 创建 `manage_map` 表

---

## 修复计划

### 1. 修复前端 API 路径
**文件**: `front/src/api/map.ts`
```typescript
// 修改前
const HTTP_PREFIX = '/wayline/api/v1'

// 修改后
const HTTP_PREFIX = '/map/api/v1'
```

### 2. 修复上传逻辑
**文件**: `front/src/components/mapdsm/CreateMapModal.vue`
- 在 `handleConfirm` 中直接调用 `uploadDsmFile` API
- 添加真实的上传进度反馈
- 上传成功后通知父组件刷新列表

### 3. 创建数据库表
执行以下 SQL:
```sql
CREATE TABLE `manage_map` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `map_id` varchar(64) NOT NULL COMMENT 'uuid',
  `map_name` varchar(100) NOT NULL COMMENT '地图名称',
  `workspace_id` varchar(64) NOT NULL COMMENT '工作区ID',
  `user_id` varchar(64) NOT NULL COMMENT '用户ID',
  `username` varchar(64) NOT NULL DEFAULT '' COMMENT '用户名',
  `map_format` varchar(32) NOT NULL COMMENT '地图格式: 3dtiles/terrain',
  `object_key` varchar(1000) NOT NULL COMMENT 'MinIO存储路径',
  `min_longitude` decimal(18,14) DEFAULT NULL,
  `max_longitude` decimal(18,14) DEFAULT NULL,
  `min_latitude` decimal(17,14) DEFAULT NULL,
  `max_latitude` decimal(17,14) DEFAULT NULL,
  `center_longitude` decimal(18,14) DEFAULT NULL,
  `center_latitude` decimal(17,14) DEFAULT NULL,
  `file_size` bigint DEFAULT 0,
  `status` tinyint(1) NOT NULL DEFAULT 0,
  `create_time` bigint NOT NULL,
  `update_time` bigint NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `map_id_UNIQUE` (`map_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COMMENT='DSM地图管理表';
```

---

## 预计修改文件数: 2
- `front/src/api/map.ts`
- `front/src/components/mapdsm/CreateMapModal.vue`